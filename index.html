<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApexFish Terminal v4.5</title>
    <style>
        /* --- CORE TERMINAL STYLES --- */
        body {
            background-color: #050505;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            margin: 0;
            padding: 20px;
            height: 100vh;
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #terminal-output {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 20px;
        }
        #input-line {
            display: flex;
            border-top: 1px solid #333;
            padding-top: 10px;
            background: #050505;
        }
        #prompt {
            color: #00ff00;
            margin-right: 10px;
            font-weight: bold;
        }
        #cmd {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            flex-grow: 1;
            outline: none;
        } 
        
        /* --- UI ELEMENTS (THE NEW STUFF) --- */
        
        /* 1. The Result Card (Wraps the text stats) */
        .result-card {
            border: 1px solid #1a1a1a;
            background: #0a0a0a;
            border-left: 3px solid #00ff00; /* Green accent bar */
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 5px;
            width: fit-content;
            min-width: 280px;
        }
        
        .result-header {
            font-size: 11px;
            color: #444;
            border-bottom: 1px solid #222;
            padding-bottom: 5px;
            margin-bottom: 8px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-grid {
            display: flex;
            gap: 20px;
            margin-bottom: 10px;
        }

        .stat-item {
            display: flex;
            flex-direction: column;
        }
        
        .stat-label {
            font-size: 10px;
            color: #555;
        }
        
        .stat-value {
            font-size: 14px;
            font-weight: bold;
            color: #00ff00;
        }

        .action-box {
            background: #0d1a0d;
            border: 1px solid #004400;
            padding: 8px;
            text-align: center;
            font-weight: bold;
            color: #00ff00;
            text-transform: uppercase;
            border-radius: 2px;
        }
        
        /* 2. The Visual Grid (Your 3x3 Box) */
        .radar-container {
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 10px;
            display: inline-block;
            border: 1px solid #1a1a1a;
            background: #0a0a0a;
            border-radius: 4px;
        }
        .radar-label {
            font-size: 10px;
            color: #444;
            margin-bottom: 5px;
            text-align: center;
            letter-spacing: 1px;
        }
        .radar-grid {
            display: grid;
            grid-template-columns: repeat(3, 40px);
            grid-template-rows: repeat(3, 40px);
            gap: 6px;
        }
        .cell {
            width: 40px;
            height: 40px;
            background: #111;
            border: 1px solid #333;
            border-radius: 2px;
            transition: all 0.2s ease;
        }
        
        /* Grid States */
        .cell.target { border: 2px solid #00ff00; box-shadow: inset 0 0 5px rgba(0,255,0,0.2); }
        .cell.possible { border: 2px dashed #aaaa00; opacity: 0.6; } /* Dimmer yellow for style */
        .cell.hit { background-color: #00ff00; border: 2px solid #00ff00; box-shadow: 0 0 15px rgba(0,255,0,0.5); }

    </style>
</head>
<body>

    <div id="terminal-output">
        <div style="opacity: 0.7; font-size: 12px; margin-bottom: 20px;">
            RIVAL'S GIGA FISH TOOL v4.5<br>
            ---------------------------<br>
            Commands: 0-8 (Positions) | 'deck' | 'reset'
        </div>
        <div style="color: yellow;">[!] SYSTEM: Please type 'deck' to set your cards first.</div>
        <br>
    </div>

    <div id="input-line">
        <span id="prompt">root@giga:~$</span>
        <input type="text" id="cmd" autofocus autocomplete="off">
    </div>

<script>
    // --- CONFIGURATION ---
    const USE_CALIBRATION = false; 

    class ApexFish {
        constructor() {
            // LOGIC: Adjacency Map (Same as Python)
            this.adj = {
                0: new Set([0, 1, 3]), 1: new Set([0, 1, 2, 4]), 2: new Set([1, 2, 5]),
                3: new Set([0, 3, 4, 6]), 4: new Set([1, 3, 4, 5, 7]), 
                5: new Set([2, 4, 5, 8]), 6: new Set([3, 6, 7]), 7: new Set([4, 6, 7, 8]), 8: new Set([5, 7, 8])
            };
            this.history = [];
            this.deck = [];
            
            // LOGIC: Spells (Same as Python)
            this.CROSS = new Set([1, 3, 4, 5, 7]);
            this.CLUSTERS = {
                0: new Set([0, 1, 3, 4]), 2: new Set([1, 2, 4, 5]),
                6: new Set([3, 4, 6, 7]), 8: new Set([4, 5, 7, 8])
            };
            this.ROWS = {0: new Set([0, 1, 2]), 3: new Set([3, 4, 5]), 6: new Set([6, 7, 8])};
        }

        print(text, color = "#00ff00") {
            const output = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.style.color = color;
            line.textContent = text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        printRaw(html) {
            const output = document.getElementById('terminal-output');
            const line = document.createElement('div');
            line.innerHTML = html;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        setDeck(inputStr) {
            this.deck = [];
            const cards = inputStr.toLowerCase().split(' ');
            cards.forEach(card => {
                // LOGIC: Shortcuts
                if (card.includes('2') || card.includes('box')) this.deck.push("2x2 CLUSTER");
                else if (card.includes('3') || card.includes('row') || card.includes('t') || card.includes('m') || card.includes('b')) this.deck.push("3x1 HORIZONTAL");
                else if (card.includes('c') || card.includes('x')) this.deck.push("CROSS SPELL");
            });
            this.print(`Deck Updated: [${this.deck.join(', ')}]`, "#00ffff");
        }

        intersect(setA, setB) {
            return new Set([...setA].filter(x => setB.has(x)));
        }

        drawRadar(targetCells, possibleCells) {
            let html = `
            <div class="radar-container">
                <div class="radar-label">TARGETING HUD</div>
                <div class="radar-grid">
            `;
            for (let i = 0; i < 9; i++) {
                let classes = 'cell';
                if (targetCells.has(i) && possibleCells.has(i)) classes += ' hit';
                else if (targetCells.has(i)) classes += ' target';
                else if (possibleCells.has(i)) classes += ' possible';
                html += `<div class="${classes}"></div>`;
            }
            html += `</div></div>`;
            this.printRaw(html);
        }

        solve(pos) {
            // LOGIC: Reset on impossible move
            if (this.history.length > 0) {
                const lastPos = this.history[this.history.length - 1];
                if (!this.adj[lastPos].has(pos)) {
                    this.print(`[!] MOVEMENT IMPOSSIBLE (${lastPos} -> ${pos})`, "orange");
                    this.print("[!] DETECTED NEW FISH: Auto-Resetting History...", "orange");
                    this.history = [];
                }
            }
            this.history.push(pos);
            if (this.history.length > 4) this.history.shift();

            if (USE_CALIBRATION && this.history.length < 3) {
                this.print(`--- CALIBRATING (${this.history.length}/3) ---`, "yellow");
                return;
            }

            const possible = new Set(this.adj[pos]);
            let volatility = "LOW";

            // LOGIC: Anti-Backtrack
            if (this.history.length >= 2) {
                const prevPos = this.history[this.history.length - 2];
                if (possible.has(prevPos) && this.history.length > 2) {
                    volatility = (this.history[this.history.length - 1] !== this.history[this.history.length - 3]) 
                        ? "HIGH" : "MODERATE";
                }
            }

            // LOGIC: Best Spell Selection
            let spellName = "";
            let spellTiles = new Set();

            if (pos === 4) {
                spellName = "CROSS SPELL";
                spellTiles = this.CROSS;
            } else if (this.CLUSTERS[pos]) {
                spellName = "2x2 CLUSTER";
                spellTiles = this.CLUSTERS[pos];
            } else {
                let rowStart = Math.floor(pos / 3) * 3;
                spellName = "3x1 HORIZONTAL";
                spellTiles = this.ROWS[rowStart];
            }

            // LOGIC: Confidence Calculation
            const hits = this.intersect(spellTiles, possible).size;
            let baseConf = (hits / possible.size) * 100;
            let finalConf = volatility === "LOW" ? baseConf : baseConf - 10;

            // LOGIC: Deck Validation
            let recommendation = "PLAY";
            let actionColor = "#00ff00"; 
            if (this.deck.length > 0) {
                if (!this.deck.includes(spellName)) {
                    recommendation = "REDRAW";
                    actionColor = "red";
                } else {
                    recommendation = `CAST ${spellName}`;
                }
            } else {
                recommendation = `CAST ${spellName} (No Deck)`;
            }

            // --- RENDER RESULT CARD (THE NEW UI PART) ---
            const resultHtml = `
            <div class="result-card">
                <div class="result-header">ANALYSIS: POSITION ${pos}</div>
                <div class="stat-grid">
                    <div class="stat-item">
                        <span class="stat-label">VOLATILITY</span>
                        <span class="stat-value" style="color: ${volatility === 'HIGH' ? 'orange' : '#00ff00'}">${volatility}</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">CONFIDENCE</span>
                        <span class="stat-value">${finalConf.toFixed(1)}%</span>
                    </div>
                </div>
                <div class="action-box" style="color: ${actionColor}; border-color: ${actionColor === 'red' ? 'red' : '#004400'}">
                    ${recommendation}
                </div>
            </div>
            `;
            
            this.printRaw(resultHtml);
            this.drawRadar(spellTiles, possible);
        }
    }

    // --- TERMINAL INTERFACE HANDLING ---
    const bot = new ApexFish();
    const input = document.getElementById('cmd');
    let waitingForDeck = false;

    input.addEventListener('keydown', function(event) {
        if (event.key === 'Enter') {
            const val = input.value.trim();
            input.value = '';
            
            // Echo the user command
            bot.printRaw(`<div style="color: #666; margin-top: 5px;">> ${val}</div>`);

            if (waitingForDeck) {
                bot.setDeck(val);
                waitingForDeck = false;
                return;
            }
            if (val.toLowerCase() === 'deck') {
                bot.print("Enter your 3 cards (e.g., '2 2 c'):");
                waitingForDeck = true;
                return;
            }
            if (val.toLowerCase() === 'reset') {
                bot.history = [];
                bot.print("History Cleared.", "orange");
                return;
            }
            if (val.toLowerCase() === 'exit') {
                bot.print("Session Terminated.", "red");
                return;
            }
            if (val.toLowerCase() === 'help') {
                bot.print("Commands: 0-8 (Position) | deck | reset", "cyan");
                bot.print("Shortcuts: c (Cross) | 2 (Box) | t/m/b (Rows)", "cyan");
                return;
            }

            if (!isNaN(parseInt(val)) && parseInt(val) >= 0 && parseInt(val) <= 8) {
                bot.solve(parseInt(val));
            } else {
                bot.print("Invalid Command.", "red");
            }
        }
    });

    document.addEventListener('click', () => input.focus());
</script>
</body>
</html>
